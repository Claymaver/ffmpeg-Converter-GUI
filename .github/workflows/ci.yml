name: CI

on:
  push:
    branches:
      - main
      - master
      - develop
  pull_request:
    branches:
      - main
      - master

jobs:
  test:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]
        node-version: ['18', '20']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Fix app-builder permissions (Linux/macOS)
        if: runner.os != 'Windows'
        run: |
          echo "Checking for app-builder binaries..."
          if [[ "$(uname)" == "Linux" ]]; then
            if [ -f "node_modules/app-builder-bin/linux/x64/app-builder" ]; then
              chmod +x node_modules/app-builder-bin/linux/x64/app-builder
              echo "✓ Fixed Linux app-builder permissions"
            else
              echo "⚠ Linux app-builder not found"
            fi
          elif [[ "$(uname)" == "Darwin" ]]; then
            if [ -f "node_modules/app-builder-bin/mac/x64/app-builder" ]; then
              chmod +x node_modules/app-builder-bin/mac/x64/app-builder
              echo "✓ Fixed macOS app-builder permissions"
            else
              echo "⚠ macOS app-builder not found"
            fi
          fi
        shell: bash
      
      - name: Verify FFmpeg installer
        run: |
          node -e "console.log('FFmpeg path:', require('@ffmpeg-installer/ffmpeg').path)"
          node -e "console.log('FFprobe path:', require('@ffprobe-installer/ffprobe').path)"
      
      - name: Check file structure
        run: |
          ls -la src/
          echo "Build config exists:"
          grep -q "electron-builder" package.json && echo "✓ electron-builder configured" || echo "✗ Missing electron-builder"
        shell: bash
      
      - name: Build package (no installer)
        run: npm run pack
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  lint:
    name: Lint Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Check code formatting
        run: |
          echo "Checking JavaScript files..."
          find src -name "*.js" -type f | wc -l
          echo "All files present ✓"
